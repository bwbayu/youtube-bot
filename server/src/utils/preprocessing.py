import unicodedata
import re
from bs4 import BeautifulSoup

# Mapping untuk mengganti karakter mirip huruf/angka (visual clones)
CHARACTER_MAP = {
    # Unicode fancy to normal
    'ð€': 'A', 'ð': 'B', 'ð‚': 'C', 'ðƒ': 'D', 'ð„': 'E', 'ð…': 'F', 'ð†': 'G',
    'ð‡': 'H', 'ðˆ': 'I', 'ð‰': 'J', 'ðŠ': 'K', 'ð‹': 'L', 'ðŒ': 'M', 'ð': 'N',
    'ðŽ': 'O', 'ð': 'P', 'ð': 'Q', 'ð‘': 'R', 'ð’': 'S', 'ð“': 'T', 'ð”': 'U',
    'ð•': 'V', 'ð–': 'W', 'ð—': 'X', 'ð˜': 'Y', 'ð™': 'Z',
    'ðš': 'a', 'ð›': 'b', 'ðœ': 'c', 'ð': 'd', 'ðž': 'e', 'ðŸ': 'f', 'ð ': 'g',
    'ð¡': 'h', 'ð¢': 'i', 'ð£': 'j', 'ð¤': 'k', 'ð¥': 'l', 'ð¦': 'm', 'ð§': 'n',
    'ð¨': 'o', 'ð©': 'p', 'ðª': 'q', 'ð«': 'r', 'ð¬': 's', 'ð­': 't', 'ð®': 'u',
    'ð¯': 'v', 'ð°': 'w', 'ð±': 'x', 'ð²': 'y', 'ð³': 'z',
    
    # Gothic/Fraktur
    'ð”„': 'A', 'ð”…': 'B', 'â„­': 'C', 'ð”‡': 'D', 'ð”ˆ': 'E', 'ð”‰': 'F', 'ð”Š': 'G',
    'ð”': 'J', 'ð”Ž': 'K', 'ð”': 'L', 'ð”': 'M', 'ð”‘': 'N', 'ð”’': 'O', 'ð”“': 'P',
    'ð””': 'Q', 'â„œ': 'R', 'ð”–': 'S', 'ð”—': 'T', 'ð”˜': 'U', 'ð”™': 'V', 'ð”š': 'W',
    'ð”›': 'X', 'ð”œ': 'Y', 'ð”ž': 'a', 'ð”Ÿ': 'b', 'ð” ': 'c', 'ð”¡': 'd',
    'ð”¢': 'e', 'ð”£': 'f', 'ð”¤': 'g', 'ð”¥': 'h', 'ð”¦': 'i', 'ð”§': 'j',
    'ð”¨': 'k', 'ð”©': 'l', 'ð”ª': 'm', 'ð”«': 'n', 'ð”¬': 'o', 'ð”­': 'p',
    'ð”®': 'q', 'ð”¯': 'r', 'ð”°': 's', 'ð”±': 't', 'ð”²': 'u', 'ð”³': 'v',
    'ð”´': 'w', 'ð”µ': 'x', 'ð”¶': 'y', 'ð”·': 'z',

    # Emoji angka ke angka
    '0ï¸âƒ£': '0', '1ï¸âƒ£': '1', '2ï¸âƒ£': '2', '3ï¸âƒ£': '3', '4ï¸âƒ£': '4',
    '5ï¸âƒ£': '5', '6ï¸âƒ£': '6', '7ï¸âƒ£': '7', '8ï¸âƒ£': '8', '9ï¸âƒ£': '9',

    # Unicode angka gaya
    'ðŸŽ': '0', 'ðŸ': '1', 'ðŸ': '2', 'ðŸ‘': '3', 'ðŸ’': '4',
    'ðŸ“': '5', 'ðŸ”': '6', 'ðŸ•': '7', 'ðŸ–': '8', 'ðŸ—': '9',

    # Bulatan/simbol angka
    'â¶': '1', 'â·': '2', 'â¸': '3', 'â¹': '4', 'âº': '5',
    'â»': '6', 'â¼': '7', 'â½': '8', 'â¾': '9', 'â¿': '10',
    
    # Simbol huruf
    'â“': 'a', 'â“‘': 'b', 'â“’': 'c', 'â““': 'd', 'â“”': 'e', 'â“•': 'f', 'â“–': 'g',
    'â“—': 'h', 'â“˜': 'i', 'â“™': 'j', 'â“š': 'k', 'â“›': 'l', 'â“œ': 'm', 'â“': 'n',
    'â“ž': 'o', 'â“Ÿ': 'p', 'â“ ': 'q', 'â“¡': 'r', 'â“¢': 's', 'â“£': 't', 'â“¤': 'u',
    'â“¥': 'v', 'â“¦': 'w', 'â“§': 'x', 'â“¨': 'y', 'â“©': 'z',
    
    # Simbol aneh
    'á—ª': 'D', 'á—©': 'A', 'á’ª': 'L', 'á‘­': 'P', 'á–‡': 'R', 'á—·': 'B', 'á‘•': 'C', 'á—·': 'B',

    'ðŸ…°ï¸': 'A', 'ðŸ…±ï¸': 'B', 'ðŸ…¾ï¸': 'O', 'ðŸ†Ž': 'AB', 'ðŸ†‘': 'CL', 'ðŸ†’': 'COOL',
    'ðŸ†“': 'FREE', 'ðŸ†”': 'ID', 'ðŸ†•': 'NEW', 'ðŸ†–': 'NG', 'ðŸ†—': 'OK',
    'ðŸ†˜': 'SOS', 'ðŸ†™': 'UP', 'ðŸ†š': 'VS',

    # Full A-Z boxed (manually added)
    'ðŸ…¿ï¸': 'P', 'ðŸ†€': 'Q', 'ðŸ†': 'R', 'ðŸ†‚': 'S', 'ðŸ†ƒ': 'T',
    'ðŸ†„': 'U', 'ðŸ†…': 'V', 'ðŸ††': 'W', 'ðŸ†‡': 'X', 'ðŸ†ˆ': 'Y', 'ðŸ†‰': 'Z',
    'ðŸ…°': 'A', 'ðŸ…±': 'B', 'ðŸ…¾': 'O', 'ðŸ…¿': 'P',

    # Emoji 0-9 (opsional untuk konsistensi)
    '0ï¸âƒ£': '0', '1ï¸âƒ£': '1', '2ï¸âƒ£': '2', '3ï¸âƒ£': '3', '4ï¸âƒ£': '4',
    '5ï¸âƒ£': '5', '6ï¸âƒ£': '6', '7ï¸âƒ£': '7', '8ï¸âƒ£': '8', '9ï¸âƒ£': '9',

    'ðŸ…°': 'A', 'ðŸ…±': 'B', 'ðŸ…²': 'C', 'ðŸ…³': 'D', 'ðŸ…´': 'E', 'ðŸ…µ': 'F',
    'ðŸ…¶': 'G', 'ðŸ…·': 'H', 'ðŸ…¸': 'I', 'ðŸ…¹': 'J', 'ðŸ…º': 'K', 'ðŸ…»': 'L',
    'ðŸ…¼': 'M', 'ðŸ…½': 'N', 'ðŸ…¾': 'O', 'ðŸ…¿': 'P', 'ðŸ†€': 'Q', 'ðŸ†': 'R',
    'ðŸ†‚': 'S', 'ðŸ†ƒ': 'T', 'ðŸ†„': 'U', 'ðŸ†…': 'V', 'ðŸ††': 'W', 'ðŸ†‡': 'X',
    'ðŸ†ˆ': 'Y', 'ðŸ†‰': 'Z',
    # Dengan VS16 (versi dengan emoji modifier) juga
    'ðŸ…°ï¸': 'A', 'ðŸ…±ï¸': 'B', 'ðŸ…¾ï¸': 'O', 'ðŸ…¿ï¸': 'P', 'ðŸ†„ï¸': 'U', 'ðŸ…»ï¸': 'L', 'ðŸ††ï¸': 'W',
    'ðŸ…¸ï¸': 'I', 'ðŸ…½ï¸': 'N', 'ðŸ†ƒï¸': 'T', 'ðŸ†‚ï¸': 'S', 'ðŸ†…ï¸': 'V', 'ðŸ†‡ï¸': 'X', 'ðŸ†ˆï¸': 'Y', 'ðŸ†‰ï¸': 'Z',

    'ðŸ…': 'A', 'ðŸ…‘': 'B', 'ðŸ…’': 'C', 'ðŸ…“': 'D', 'ðŸ…”': 'E', 'ðŸ…•': 'F',
    'ðŸ…–': 'G', 'ðŸ…—': 'H', 'ðŸ…˜': 'I', 'ðŸ…™': 'J', 'ðŸ…š': 'K', 'ðŸ…›': 'L',
    'ðŸ…œ': 'M', 'ðŸ…': 'N', 'ðŸ…ž': 'O', 'ðŸ…Ÿ': 'P', 'ðŸ… ': 'Q', 'ðŸ…¡': 'R',
    'ðŸ…¢': 'S', 'ðŸ…£': 'T', 'ðŸ…¤': 'U', 'ðŸ…¥': 'V', 'ðŸ…¦': 'W', 'ðŸ…§': 'X',
    'ðŸ…¨': 'Y', 'ðŸ…©': 'Z',

    # Enclosed numbers (circled)
    'â‘ ': '1', 'â‘¡': '2', 'â‘¢': '3', 'â‘£': '4', 'â‘¤': '5',
    'â‘¥': '6', 'â‘¦': '7', 'â‘§': '8', 'â‘¨': '9', 'â‘©': '10',
    'â‘ª': '11', 'â‘«': '12', 'â‘¬': '13', 'â‘­': '14', 'â‘®': '15',
    'â‘¯': '16', 'â‘°': '17', 'â‘±': '18', 'â‘²': '19', 'â‘³': '20',
    'â“ª': '0',

    # Fullwidth digits
    'ï¼': '0', 'ï¼‘': '1', 'ï¼’': '2', 'ï¼“': '3', 'ï¼”': '4',
    'ï¼•': '5', 'ï¼–': '6', 'ï¼—': '7', 'ï¼˜': '8', 'ï¼™': '9',

    # Fullwidth A-Z
    'ï¼¡': 'A', 'ï¼¢': 'B', 'ï¼£': 'C', 'ï¼¤': 'D', 'ï¼¥': 'E', 'ï¼¦': 'F',
    'ï¼§': 'G', 'ï¼¨': 'H', 'ï¼©': 'I', 'ï¼ª': 'J', 'ï¼«': 'K', 'ï¼¬': 'L',
    'ï¼­': 'M', 'ï¼®': 'N', 'ï¼¯': 'O', 'ï¼°': 'P', 'ï¼±': 'Q', 'ï¼²': 'R',
    'ï¼³': 'S', 'ï¼´': 'T', 'ï¼µ': 'U', 'ï¼¶': 'V', 'ï¼·': 'W', 'ï¼¸': 'X',
    'ï¼¹': 'Y', 'ï¼º': 'Z',

    # Fullwidth a-z
    'ï½': 'a', 'ï½‚': 'b', 'ï½ƒ': 'c', 'ï½„': 'd', 'ï½…': 'e', 'ï½†': 'f',
    'ï½‡': 'g', 'ï½ˆ': 'h', 'ï½‰': 'i', 'ï½Š': 'j', 'ï½‹': 'k', 'ï½Œ': 'l',
    'ï½': 'm', 'ï½Ž': 'n', 'ï½': 'o', 'ï½': 'p', 'ï½‘': 'q', 'ï½’': 'r',
    'ï½“': 's', 'ï½”': 't', 'ï½•': 'u', 'ï½–': 'v', 'ï½—': 'w', 'ï½˜': 'x',
    'ï½™': 'y', 'ï½š': 'z',

    # Fancy bold letters a-z (ðš â€“ ð³)
    'ðš': 'a', 'ð›': 'b', 'ðœ': 'c', 'ð': 'd', 'ðž': 'e', 'ðŸ': 'f',
    'ð ': 'g', 'ð¡': 'h', 'ð¢': 'i', 'ð£': 'j', 'ð¤': 'k', 'ð¥': 'l',
    'ð¦': 'm', 'ð§': 'n', 'ð¨': 'o', 'ð©': 'p', 'ðª': 'q', 'ð«': 'r',
    'ð¬': 's', 'ð­': 't', 'ð®': 'u', 'ð¯': 'v', 'ð°': 'w', 'ð±': 'x',
    'ð²': 'y', 'ð³': 'z',

    # Math double-struck (ð”¸ â€“ ð•«)
    'ð”¸': 'A', 'ð”¹': 'B', 'â„‚': 'C', 'ð”»': 'D', 'ð”¼': 'E', 'ð”½': 'F',
    'ð”¾': 'G', 'â„': 'H', 'ð•€': 'I', 'ð•': 'J', 'ð•‚': 'K', 'ð•ƒ': 'L',
    'ð•„': 'M', 'â„•': 'N', 'ð•†': 'O', 'â„™': 'P', 'â„š': 'Q', 'â„': 'R',
    'ð•Š': 'S', 'ð•‹': 'T', 'ð•Œ': 'U', 'ð•': 'V', 'ð•Ž': 'W', 'ð•': 'X',
    'ð•': 'Y', 'â„¤': 'Z',

    'ð•’': 'a', 'ð•“': 'b', 'ð•”': 'c', 'ð••': 'd', 'ð•–': 'e', 'ð•—': 'f',
    'ð•˜': 'g', 'ð•™': 'h', 'ð•š': 'i', 'ð•›': 'j', 'ð•œ': 'k', 'ð•': 'l',
    'ð•ž': 'm', 'ð•Ÿ': 'n', 'ð• ': 'o', 'ð•¡': 'p', 'ð•¢': 'q', 'ð•£': 'r',
    'ð•¤': 's', 'ð•¥': 't', 'ð•¦': 'u', 'ð•§': 'v', 'ð•¨': 'w', 'ð•©': 'x',
    'ð•ª': 'y', 'ð•«': 'z',

    # Mathematical italic and script variants
    'ð’œ': 'A', 'ð’ž': 'C', 'ð’Ÿ': 'D', 'ð’¢': 'G', 'ð’¥': 'J', 'ð’¦': 'K',
    'ð’©': 'N', 'ð’ª': 'O', 'ð’«': 'P', 'ð’¬': 'Q', 'ð’®': 'S', 'ð’¯': 'T',
    'ð’°': 'U', 'ð’±': 'V', 'ð’²': 'W', 'ð’³': 'X', 'ð’´': 'Y', 'ð’µ': 'Z',
    'ð’¶': 'a', 'ð’·': 'b', 'ð’¸': 'c', 'ð’¹': 'd', 'ð‘’': 'e', 'ð’»': 'f',
    'ð‘”': 'g', 'ð’½': 'h', 'ð’¾': 'i', 'ð’¿': 'j', 'ð“€': 'k', 'ð“': 'l',
    'ð“‚': 'm', 'ð“ƒ': 'n', 'ð‘œ': 'o', 'ð“…': 'p', 'ð“†': 'q', 'ð“‡': 'r',
    'ð“ˆ': 's', 'ð“‰': 't', 'ð“Š': 'u', 'ð“‹': 'v', 'ð“Œ': 'w', 'ð“': 'x',
    'ð“Ž': 'y', 'ð“': 'z',

    # Superscript & Subscript Numbers
    'â°': '0', 'Â¹': '1', 'Â²': '2', 'Â³': '3',
    'â´': '4', 'âµ': '5', 'â¶': '6', 'â·': '7', 'â¸': '8', 'â¹': '9',

    'â‚€': '0', 'â‚': '1', 'â‚‚': '2', 'â‚ƒ': '3',
    'â‚„': '4', 'â‚…': '5', 'â‚†': '6', 'â‚‡': '7', 'â‚ˆ': '8', 'â‚‰': '9',

    # Greek Lookalikes
    'Î‘': 'A', 'Î’': 'B', 'Î•': 'E', 'Î–': 'Z', 'Î—': 'H',
    'Î™': 'I', 'Îš': 'K', 'Îœ': 'M', 'Î': 'N', 'ÎŸ': 'O',
    'Î¡': 'P', 'Î¤': 'T', 'Î¥': 'Y', 'Î§': 'X',

    # Roman Numerals
    'â… ': '1', 'â…¡': '2', 'â…¢': '3', 'â…£': '4', 'â…¤': '5',
    'â…¥': '6', 'â…¦': '7', 'â…§': '8', 'â…¨': '9', 'â…©': '10',

    # Braille Patterns
    'â ': 'A', 'â ƒ': 'B', 'â ‰': 'C', 'â ™': 'D', 'â ‘': 'E', 'â ‹': 'F',
    'â ›': 'G', 'â “': 'H', 'â Š': 'I', 'â š': 'J', 'â …': 'K', 'â ‡': 'L',
    'â ': 'M', 'â ': 'N', 'â •': 'O', 'â ': 'P', 'â Ÿ': 'Q', 'â —': 'R',
    'â Ž': 'S', 'â ž': 'T', 'â ¥': 'U', 'â §': 'V', 'â º': 'W', 'â ­': 'X',
    'â ½': 'Y', 'â µ': 'Z',

    # Regional Indicator Symbols
    'ðŸ‡¦': 'A', 'ðŸ‡§': 'B', 'ðŸ‡¨': 'C', 'ðŸ‡©': 'D', 'ðŸ‡ª': 'E',
    'ðŸ‡«': 'F', 'ðŸ‡¬': 'G', 'ðŸ‡­': 'H', 'ðŸ‡®': 'I', 'ðŸ‡¯': 'J',
    'ðŸ‡°': 'K', 'ðŸ‡±': 'L', 'ðŸ‡²': 'M', 'ðŸ‡³': 'N', 'ðŸ‡´': 'O',
    'ðŸ‡µ': 'P', 'ðŸ‡¶': 'Q', 'ðŸ‡·': 'R', 'ðŸ‡¸': 'S', 'ðŸ‡¹': 'T',
    'ðŸ‡º': 'U', 'ðŸ‡»': 'V', 'ðŸ‡¼': 'W', 'ðŸ‡½': 'X', 'ðŸ‡¾': 'Y',
    'ðŸ‡¿': 'Z',

    # Small Caps Unicode
    'á´€': 'a', 'Ê™': 'b', 'á´„': 'c', 'á´…': 'd', 'á´‡': 'e', 'Ò“': 'f',
    'É¢': 'g', 'Êœ': 'h', 'Éª': 'i', 'á´Š': 'j', 'á´‹': 'k', 'ÊŸ': 'l',
    'á´': 'm', 'É´': 'n', 'á´': 'o', 'á´˜': 'p', 'Ç«': 'q', 'Ê€': 'r',
    's': 's', 'á´›': 't', 'á´œ': 'u', 'á´ ': 'v', 'á´¡': 'w', 'x': 'x',
    'Ê': 'y', 'á´¢': 'z', 'Ã˜': 'O',

    # Greek
    'Î‘': 'A',  # Alpha
    'Î’': 'B',  # Beta
    'Î•': 'E',  # Epsilon
    'Î–': 'Z',  # Zeta
    'Î—': 'H',  # Eta
    'Î™': 'I',  # Iota
    'Îš': 'K',  # Kappa
    'Îœ': 'M',  # Mu
    'Î': 'N',  # Nu
    'ÎŸ': 'O',  # Omicron
    'Î¡': 'P',  # Rho
    'Î¤': 'T',  # Tau
    'Î¥': 'Y',  # Upsilon
    'Î§': 'X',  # Chi
    'Î›': 'A',  # Lambda (ðŸ”´ kasus kamu)
    'Î”': 'A',  # Delta (opsional)

    # Cyrillic (Russian lookalikes)
    'Ð°': 'a', 'Ðµ': 'e', 'Ð¾': 'o', 'Ñ€': 'p', 'Ñ': 'c', 'Ñ…': 'x',
    'Ð': 'A', 'Ð’': 'B', 'Ð•': 'E', 'Ðš': 'K', 'Ðœ': 'M', 'Ð': 'H',
    'Ðž': 'O', 'Ð ': 'P', 'Ð¡': 'C', 'Ð¢': 'T', 'Ð¥': 'X',

    # 
    'â„¬': 'B', 'â„°': 'E', 'â„±': 'F', 'â„‹': 'H', 'â„': 'I', 'â„’': 'L',
    'â„³': 'M', 'â„›': 'R', 'á—¯': 'W',  # Looks like capital W
    'á—·': 'B',  # Looks like capital B
    'á—©': 'A',
    'á’ª': 'L',
    'á‘Ž': 'N',
    'á‘Œ': 'U',
    'á—°': 'M',
    'á‘­': 'P',
    'á‘«': 'Q',

    # 
    'Ð²': 'b', 'Ñ”': 'e', 'Ñ‚': 't',
    # Greek
    'Ï': 'p', 'Ïƒ': 'o', 'Î·': 'n',

    # Cyrillic & Greek lookalike Latin
    'Î‘': 'A', 'Ð': 'A', 'Î’': 'B', 'Ð’': 'B', 'Ð¡': 'C', 'Ð•': 'E', 'Î•': 'E',
    'Î—': 'H', 'Ð': 'H', 'Î™': 'I', 'Ð†': 'I', 'Ðˆ': 'J', 'Îš': 'K', 'Ðš': 'K',
    'Îœ': 'M', 'Ðœ': 'M', 'Î': 'N', 'Ðž': 'O', 'ÎŸ': 'O', 'Î¡': 'P', 'Ð ': 'P',
    'Ð…': 'S', 'Î¤': 'T', 'Ð¢': 'T', 'Î§': 'X', 'Ð¥': 'X', 'Î¥': 'Y', 'Ò®': 'Y',
    'Ð°': 'a', 'Ñ': 'c', 'Ðµ': 'e', 'Ñ”': 'e', 'Ò½': 'e', 'É¡': 'g', 'Ò»': 'h',
    'Ñ–': 'i', 'Ó': 'i', 'Â¡': 'i', 'Ñ˜': 'j', 'Î¿': 'o', 'Ð¾': 'o', 'Ó©': 'o',
    'Ð¿': 'n', 'Î·': 'n', 'Ï': 'p', 'Ñ€': 'p', 'Ñ•': 's', 'Ñ‚': 't', 'Ñµ': 'v',
    'Î½': 'v', 'Ð²': 'b', 'Ñ…': 'x', 'Ï‡': 'x', 'Ñƒ': 'y', 'Ò¯': 'y',

    # Visual digit clones
    'ã€‡': '0', 'Ð—': '3', 'Æ¼': '5', 'ßˆ': '4'
}

def strip_urls_and_timestamps(text: str) -> str:
    # Hapus URL penuh (http, https, www)
    text = re.sub(r'https?://\S+|www\.\S+', '', text)

    # Hapus URL shortener umum seperti bit.ly, t.co, dll.
    text = re.sub(r'\b(bit\.ly|tinyurl\.com|t\.co|goo\.gl|linktr\.ee)/\S+', '', text)

    # Hapus timestamp video dalam format 00:12 atau 1:02:03
    text = re.sub(r'\b\d{1,2}:\d{2}(?::\d{2})?\b', '', text)

    return text

def strip_html_tags(text: str) -> str:
    # Hapus seluruh tag HTML dan ambil teksnya saja
    return BeautifulSoup(text, "html.parser").get_text()

def strip_symbols_prefix(text: str) -> str:
    # Ubah @mention dan #hashtag menjadi kata biasa tanpa simbolnya
    return re.sub(r'[@#](\w+)', r'\1', text)

# Fungsi utama normalisasi teks
def normalize_text(text: str) -> str:
    # Hapus tag HTML
    text = strip_html_tags(text)

    # Hapus URL, shortener, dan timestamp
    text = strip_urls_and_timestamps(text)

    # Hapus simbol @ dan # di awal kata (biarkan katanya tetap ada)
    text = strip_symbols_prefix(text)

    # Ganti karakter spesial berdasarkan peta karakter
    text = ''.join(CHARACTER_MAP.get(char, char) for char in text)

    # Normalisasi Unicode dan hapus karakter combining (misalnya aksen atau garis bawah panjang)
    text = unicodedata.normalize('NFKD', text)
    text = ''.join([c for c in text if not unicodedata.combining(c)])

    # Hapus karakter zero-width/invisible seperti ZWJ dan ZWNJ
    text = re.sub(r'[\u200B\u200C\u200D\uFEFF]', '', text)

    # Hapus simbol/emoji non-informasi, hanya pertahankan huruf, angka, spasi, dan dash
    text = re.sub(r'[^\w\s\-]', ' ', text)

    # Ubah ke huruf kecil dan hapus spasi di awal/akhir
    return text.lower().strip()

def tokenize_text(tokenizer, data):
    return tokenizer(data['text'], max_length=512, truncation=True, padding='max_length')
